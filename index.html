<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lifehouse Semkovo — Къща за гости</title>

<!-- Firebase (compat build) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --glass-bg:rgba(20,20,20,.45);
    --text:#f5f5f5;
    --accent:#ffd166;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

  /* Fullscreen hero with background */
  .hero{
    position:relative;min-height:100%;
    background:url("lifehouse-semkovo.jpg") center/cover no-repeat fixed;
    color:#fff;
  }

  /* NAV */
.nav{
  position:fixed; top:0; left:0; right:0; z-index:120;
  display:flex; align-items:center; gap:12px;
  padding:10px 14px;
  border:1px solid rgba(255,255,255,.25);
  background:var(--glass-bg); backdrop-filter:saturate(140%) blur(8px);
}

  .brand{font-weight:700;letter-spacing:.4px;white-space:nowrap}
  .brand img {height:100%;max-height:48px;width:auto;display:block}
  .burger{
    width:42px;height:38px;border-radius:10px;border:1px solid rgba(255,255,255,.25);
    display:grid;place-items:center;background:transparent;color:#fff;cursor:pointer
  }
  .burger span,.burger::before,.burger::after{
    content:"";display:block;width:20px;height:2px;background:#fff;border-radius:2px
  }
  .burger span{margin:4px 0}

  /* Drawer */
  .drawer{
    position:fixed; left:10px; top:calc(10px + 48px);
    width:clamp(240px,70vw,360px); max-height:70vh; overflow:auto;
    padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.25);
    background:var(--glass-bg); backdrop-filter:saturate(140%) blur(10px);
    z-index:110; display:none;
  }
  .drawer a, .drawer button{
    display:block;color:var(--text);text-decoration:none;
    padding:14px 12px;margin:4px 0;border-radius:10px;font-size:16px;font-weight:600;
    width:100%; text-align:left; background:transparent; border:none; cursor:pointer;
  }
  .drawer a:hover, .drawer button:hover{background:rgba(255,255,255,.1)}
  .drawer.show{display:block}

  /* Headline */
  .headline{
    position:absolute;left:50%;top:65%;transform:translate(-50%,-50%);
    text-align:center;padding:14px 18px;border-radius:16px;
    background:rgba(0,0,0,.35);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.2)
  }
  .headline h1{margin:0 0 6px 0;font-size:28px}
  .headline p{margin:0;font-size:14px;opacity:.95}


  /* Sections */
  section{min-height:60vh;padding:60px 18px;color:#fff}
  #about,#gallery,#contact{background:rgba(0,0,0,.35)}
  .btn-primary{display:inline-block;margin-top:10px;background:var(--accent);color:#222;padding:10px 14px;border-radius:12px;text-decoration:none;font-weight:600}

  /* Modal */
  .modal{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; z-index:200; padding:14px
  }
  .modal.show{display:flex}
  .modal-card{
    position:relative; width:min(1100px,96vw); height:min(740px,92vh); padding:14px;
    border-radius:18px; background:#111; box-shadow:0 10px 40px rgba(0,0,0,.5);
    color:#eee; border:1px solid #2a2a2a; overflow:hidden;
  }
  .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .x{border:1px solid #333;background:#181818;color:#ddd;border-radius:10px;padding:8px 12px;cursor:pointer}

  /* Calendar UI */
  .cal{height:calc(100% - 42px)}
  .cal .head { display:flex; justify-content:space-between; align-items:center; margin:6px 0 10px }
  .navbtn { cursor:pointer; border:1px solid #333; padding:6px 10px; border-radius:10px; background:#1b1b1b; color:#eee }
  .grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
  .dow { text-align:center; font-size:12px; color:#9aa; }
  .day {
    position:relative;
    border:1px solid #2d2f33; border-radius:12px; padding:14px 0; text-align:center; background:#202225;
    cursor:default; transition:filter .15s, background .15s, transform .05s; color:#e5e7eb;
  }
  .day.btn { cursor:pointer }
  .day.btn:active{ filter:brightness(.82); transform:scale(.98) }
  .day.btn:focus-visible{ outline:2px solid rgba(255,255,255,.6); outline-offset:2px }
  .day.busy { background:#4b5563; color:#0b0e12 }
  .day.out { opacity:.28 }
  .legend{font-size:12px;margin-top:10px;color:#bcc}
  .legend .box{display:inline-block;width:14px;height:14px;border:1px solid #2d2f33;vertical-align:-2px;margin-right:6px;background:#202225}
  .legend .box.busy{background:#4b5563;border-color:#52575f}

  /* Busy X */
  .day.busy { position: relative; background:#4b5563; color:transparent; }
  .day.busy::after { content:"✕"; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:18px; color:#fff; }

  /* Note indicator */
  .day.has-note::before{
    content:""; position:absolute; top:6px; right:6px; width:8px; height:8px; border-radius:50%;
    background:#ffd166; box-shadow:0 0 0 1px #2d2f33;
  }

  /* Notes panel */
  .notes-panel{
    position:absolute; right:-420px; top:0; height:100%; width:400px;
    background:#0f1216; border-left:1px solid #2a2f37; box-shadow:-10px 0 30px rgba(0,0,0,.35);
    transition:right .22s ease; padding:14px; display:flex; flex-direction:column; gap:10px;
  }
  .notes-panel.show{ right:0; }
  .notes-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .notes-title{font-weight:700}
  .notes-close{cursor:pointer;border:1px solid #333;background:#1b1f27;color:#ddd;border-radius:10px;padding:6px 10px}
  .notes-text{flex:1; width:100%; resize:none; background:#0b0e13; color:#e7e9ee; border:1px solid #2a2f37; border-radius:12px; padding:10px; line-height:1.4}
  .notes-actions{display:flex;gap:8px;justify-content:flex-end}
  .btn{cursor:pointer;border:1px solid #333;background:#1b1b1b;color:#eee;border-radius:10px;padding:8px 12px}
  .btn.primary{background:var(--accent);color:#111;border-color:#caa84e;font-weight:700}
  @media (max-width:520px){
    .notes-panel{ width:92vw; right:-92vw; }
    .notes-panel.show{ right:0; }
  }

  .notes-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .notes-row label{font-size:13px;color:#cfd3da;display:flex;align-items:center;gap:6px}
  .notes-row input[type="date"]{background:#0b0e13;color:#e7e9ee;border:1px solid #2a2f37;border-radius:10px;padding:6px 8px}

  /* Малък индикатор за админ статуса */
  .admin-badge{font-size:12px;opacity:.8;margin-left:8px}

  /* Админ бутон – долу вдясно на сайта (не fixed) */
  .admin-hotspot{
    display:block;
    width:64px;
    height:64px;
    background:transparent;
    border:none;
    cursor:pointer;
    opacity:0;          /* невидим, но кликаем */
    margin-left:auto;
    margin-right:0;
    margin-top:40px;
    margin-bottom:0;
  }
  .admin-hotspot:focus-visible{
    outline:2px dashed rgba(255,255,255,.6);
    outline-offset:4px;
  }

  /* Admin drawer (част от потока, вдясно долу) */
  .admin-drawer{
    position:relative;
    margin-left:auto;
    margin-right:0;
    width:clamp(240px, 60vw, 360px);
    max-height:70vh;
    overflow:auto;
    padding:12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.25);
    background:var(--glass-bg);
    backdrop-filter:saturate(140%) blur(10px);
    display:none;
    color:var(--text);
  }
  .admin-drawer.show{ display:block }

  .admin-drawer-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
  .admin-close{ cursor:pointer; border:1px solid #333; background:#1b1b1b; color:#eee; border-radius:10px; padding:6px 10px }

  .admin-drawer-body button{
    display:block; width:100%; text-align:left; cursor:pointer;
    border:none; background:transparent; color:var(--text);
    padding:12px; border-radius:10px; font-weight:600;
  }
  .admin-drawer-body button:hover{ background:rgba(255,255,255,.1) }
  /* бутони в нав бара */
.nav .social{
  display:flex;
  align-items:center;
  justify-content:center;
  width:36px;
  height:36px;
  border-radius:50%;
  color:#ccc;          /* сиво, неутрално */
  transition:color .25s, background .25s;
}
.nav .social:hover{ background:rgba(255,255,255,.1); }

.nav .social.fb:hover{ color:#1877F2; }  /* Facebook синьо */
.nav .social.ig:hover{ color:#E4405F; }  /* Instagram розово-червено */
.fixed-contacts{
  position:fixed;
  bottom:20px;
  right:20px;
  display:flex;
  flex-direction:column;
  gap:10px;
  z-index:150;
}

.fixed-contacts .contact-btn{
  width:44px;
  height:44px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.4);
  color:#ccc;
  text-decoration:none;
  transition:color .25s, background .25s;
}

.fixed-contacts .contact-btn:hover{ background:rgba(255,255,255,.1); }

/* цветове при hover */
.fixed-contacts .contact-btn.tel:hover{ color:#34A853; }   /* зелено телефон */
.fixed-contacts .contact-btn.wa:hover{ color:#25D366; }    /* WhatsApp */
.fixed-contacts .contact-btn.viber:hover{ color:#7360F2; } /* Viber */

#rules, #reviews{
background: rgba(50,50,50,.35);

  color:#fff;
  padding:60px 18px;
  min-height:40vh;
}

</style>
</head>
<body>

  <div class="hero" id="home">
    <!-- NAV -->
    <nav class="nav">
     
      <button class="burger" id="burger" aria-label="Меню" aria-expanded="false"><span></span></button>

      <!-- ПИН към Google Maps, до хамбургера -->
      <a href="https://www.google.com/maps/place/Life+House/@42.0479645,23.5272436,142m/data=!3m1!1e3!4m17!1m7!3m6!1s0x14ab05c2b76ace83:0x9ce278f0d33929d!2sSemkovo+Mountain+Resort!8m2!3d42.0446093!4d23.5258354!16s%2Fg%2F11jm7lr6cv!3m8!1s0x14ab05371801afd1:0x1abbb9a791e4b886!5m2!4m1!1i2!8m2!3d42.0481271!4d23.5274758!16s%2Fg%2F11f8mg2m1x?entry=ttu"
         target="_blank" aria-label="Google Maps">
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" viewBox="0 0 16 16" style="color:#ffd166;cursor:pointer">
          <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
        </svg>
      </a>

<a href="https://facebook.com" target="_blank" class="social fb" aria-label="Facebook">
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
    <path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 5 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.507 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.891h-2.33v6.987C18.343 21.128 22 17 22 12z"/>
  </svg>
</a>

<a href="https://instagram.com" target="_blank" class="social ig" aria-label="Instagram">
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
    <path d="M7 2C4.243 2 2 4.243 2 7v10c0 2.757 2.243 5 5 5h10c2.757 0 5-2.243 5-5V7c0-2.757-2.243-5-5-5H7zm10 2c1.654 0 3 1.346 3 3v10c0 1.654-1.346 3-3 3H7c-1.654 0-3-1.346-3-3V7c0-1.654 1.346-3 3-3h10zm-5 3a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6zm4.5-.75a1.25 1.25 0 11-2.5 0 1.25 1.25 0 012.5 0z"/>
  </svg>
</a>

      <div class="drawer" id="drawer" role="menu" aria-hidden="true">
        <a href="#" id="openCalFromMenu" role="menuitem">Календар</a>
        <a href="#gallery" role="menuitem">Галерия</a>
        <a href="#about" role="menuitem">За нас</a>
      </div>
    </nav>

    <!-- Callout -->
    <div class="headline">
      <h1>Къща за гости LifeHouse Semkovo</h1>
      <p>Домашен уют с модерни удобства на крачка от дивата природа или нещо такова....</p>
      <a class="btn-primary" id="openCalCta" href="#">свободни дати</a>
    </div>

  </div>

  <section id="about"><h2>За нас</h2><p>Уютна дървена къща с модерни удобства в сърцето на Семково.</p></section>
  
  <!-- нова секция Правила за отказ от резервация -->
  <section id="rules">
    <h2>Правила за отказ от резервация</h2>
    <p>Ако откажете резервация до 7 дни преди настаняване – без такса. При отказ по-малко от 7 дни преди настаняване се удържа 50% от сумата.</p>
  </section>

  <!-- нова секция Отзиви -->
  <section id="reviews">
    <h2>Отзиви</h2>
    <p>„Страхотно място! Уют и спокойствие.“ – Иван<br>
       „Природа, чист въздух и удобна къща.“ – Мария</p>
  </section>
  <section id="gallery"><h2>Гаалерия</h2><p>Снимки и видео ще добавим тук.</p></section>
  <section id="contact"><h2></h2><p>Тел: +359988988623    booking@lifehouse.bg</p></section>

  <!-- Admin Drawer (част от потока на страницата) -->
  <div class="admin-drawer" id="adminDrawer" aria-hidden="true">
    <div class="admin-drawer-head">
      <strong>Админ панел</strong>
      <button class="admin-close" id="adminClose" aria-label="Затвори">×</button>
    </div>
    <div class="admin-drawer-body">
      <button id="adminLogin">Админ вход</button>
      <button id="adminLogout">Изход</button>
      <div id="adminBadge" class="admin-badge">Статус: гост</div>
    </div>
  </div>

  <!-- Невидим бутон долу вдясно (в края на сайта) -->
  <button class="admin-hotspot" id="adminHotspot" aria-label="Админ панел"></button>

  <!-- ===== КАЛЕНДАР МОДАЛ ===== -->
  <div class="modal" id="calModal" aria-hidden="true" aria-label="Календар за заетост">
    <div class="modal-card">
      <div class="modal-head">
        <strong>свободни дати</strong>
        <div><button class="x" id="closeCal">Затвори</button></div>
      </div>
      <div class="cal">
        <div class="head">
          <button class="navbtn" id="prev">‹</button>
          <div id="monthLabel"></div>
          <button class="navbtn" id="next">›</button>
        </div>
        <div class="grid" id="grid"></div>
        <div class="legend">
          <span class="box"></span> свободно &nbsp; <span class="box busy"></span> заето
        </div>
      </div>

      <!-- Notes panel -->
      <aside class="notes-panel" id="notesPanel" aria-hidden="true">
        <div class="notes-head">
          <div class="notes-title" id="notesTitle">Бележка</div>
          <button class="notes-close" id="closeNotes">Затвори</button>
        </div>

        <div class="notes-row">
          <label>От: <input type="date" id="notesStart"></label>
          <label>До: <input type="date" id="notesEnd"></label>
        </div>

        <textarea class="notes-text" id="notesText" placeholder="пиши тук…"></textarea>
        <div class="notes-actions">
          <button class="btn" id="deleteNotes">Изтрий</button>
          <button class="btn primary" id="saveNotes">Запази</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- ===== Основни скриптове ===== -->
  <script>
  /* ===== Firebase INIT (сложи своя config при нужда) ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyD_2EbEpx0E-Fpvt-4YqFduD5sXkLJNbS8",
    authDomain: "lifehouse-24137.firebaseapp.com",
    projectId: "lifehouse-24137",
    storageBucket: "lifehouse-24137.appspot.com",
    messagingSenderId: "1017631883575",
    appId: "1:1017631883575:web:bd44bb5b32bf21e34b1ab2"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  /* ===== Drawer ===== */
  const burger = document.getElementById('burger');
  const drawer = document.getElementById('drawer');
  burger.addEventListener('click',()=>{
    const open = drawer.classList.toggle('show');
    burger.setAttribute('aria-expanded', String(open));
    drawer.setAttribute('aria-hidden', String(!open));
  });
  document.addEventListener('click', (e)=>{
    if (!drawer.contains(e.target) && !burger.contains(e.target)) {
      drawer.classList.remove('show');
      burger.setAttribute('aria-expanded','false');
    }
  });

  /* ===== Modal open/close (устойчиво вързване) ===== */
  const calModal = document.getElementById('calModal');

  function openCalendar(e){
    e && e.preventDefault();
    if (!calModal) return;
    calModal.classList.add('show');
    calModal.setAttribute('aria-hidden','false');
    drawer && drawer.classList.remove('show');
  }
  function closeCalendar(){
    if (!calModal) return;
    calModal.classList.remove('show');
    calModal.setAttribute('aria-hidden','true');
    typeof closeNotes === 'function' && closeNotes();
  }

  ['openCalHotspot','openCalFromMenu','openCalCta']
    .map(id => document.getElementById(id))
    .filter(Boolean)
    .forEach(el => el.addEventListener('click', openCalendar));

  const closeCalBtn = document.getElementById('closeCal');
  closeCalBtn && closeCalBtn.addEventListener('click', closeCalendar);

  calModal && calModal.addEventListener('click', (e)=>{
    if (e.target === calModal) closeCalendar();
  });

  /* ===== Calendar state ===== */
  const grid = document.getElementById('grid');
  const monthLabel = document.getElementById('monthLabel');
  const state = { y: new Date().getFullYear(), m: new Date().getMonth() };

  /* ===== Remote busy for current month (doc per month) ===== */
  let unsubBusy = null;
  let currentBusySet = new Set(); // от Firestore

  function busyDocRef(y,m){ return db.collection('state').doc(`busy_${y}_${m}`); }

  function attachBusyListener(y,m){
    if (unsubBusy) unsubBusy();
    unsubBusy = busyDocRef(y,m).onSnapshot(snap=>{
      const arr = snap.exists ? (snap.data().list || []) : [];
      currentBusySet = new Set(arr);
      updateBusyClasses();
    });
  }
  async function saveBusyRemote(set){
    if (!window.IS_ADMIN) return;
    await busyDocRef(state.y, state.m).set({ list: [...set] }, { merge:false });
  }

  /* ===== Notes ranges (global doc) ===== */
  const rangesDoc = db.collection('state').doc('ranges');
  let unsubRanges = null;
  let currentRanges = []; // [{start,end,text},...]

  function attachRangesListener(){
    if (unsubRanges) return; // един слушател е достатъчен
    unsubRanges = rangesDoc.onSnapshot(snap=>{
      currentRanges = snap.exists ? (snap.data().list || []) : [];
      markNoteDots();
    });
  }
  async function saveRangesRemote(arr){
    if (!window.IS_ADMIN) return;
    await rangesDoc.set({ list: arr });
  }
  function hasRangeNote(iso){
    return currentRanges.some(r => iso >= r.start && iso <= r.end);
  }

  /* ===== Render calendar ===== */
  function renderCal(){
    const y = state.y, m = state.m;
    const d1 = new Date(y,m,1);
    const startDow = (d1.getDay()+6)%7;
    const daysInMonth = new Date(y,m+1,0).getDate();
    const prevDays = new Date(y,m,0).getDate();

    monthLabel.innerHTML = `<strong>${d1.toLocaleString('bg-BG',{month:'long'})}</strong> ${y}`;
    let cells = '';
    const dows = ['П','В','С','Ч','П','С','Н'].map(x=>`<div class="dow">${x}</div>`).join('');
    cells += dows;

    for(let i=0;i<startDow;i++){ cells += `<div class="day out">${prevDays - startDow + i + 1}</div>`; }
    for(let day=1; day<=daysInMonth; day++){
      const iso = new Date(y,m,day).toISOString().slice(0,10);
      const cls = `day btn`;
      cells += `<button class="${cls}" data-iso="${iso}" aria-label="Ден ${day}">${day}</button>`;
    }
    const cellsSoFar = 7 + startDow + daysInMonth;
    const pad = 7*6 - (cellsSoFar - 7);
    for(let i=0;i<pad;i++){ cells += `<div class="day out">${i+1}</div>`; }

    grid.innerHTML = cells;

    // клик за заетост (само админ)
    grid.querySelectorAll('.day.btn').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        if (!window.IS_ADMIN) return;
        const cell = ev.currentTarget;
        const iso = cell.dataset.iso;
        const set = new Set(currentBusySet);
        const nowBusy = !set.has(iso);
        if (nowBusy) set.add(iso); else set.delete(iso);
        currentBusySet = set;
        updateBusyClasses();
        saveBusyRemote(set).catch(console.error);
      });

      // дабълклик за бележки
      btn.addEventListener('dblclick',(ev)=>{
        ev.preventDefault();
        const iso = ev.currentTarget.dataset.iso;
        openNotes(iso);
      });
    });

    attachBusyListener(y,m);
    attachRangesListener();
    updateBusyClasses();
    markNoteDots();
  }

  function updateBusyClasses(){
    grid.querySelectorAll('.day.btn').forEach(cell=>{
      const iso = cell.dataset.iso;
      cell.classList.toggle('busy', currentBusySet.has(iso));
    });
  }
  function markNoteDots(){
    grid.querySelectorAll('.day.btn').forEach(cell=>{
      const iso = cell.dataset.iso;
      cell.classList.toggle('has-note', hasRangeNote(iso));
    });
  }

  /* ===== Month nav ===== */
  document.getElementById('prev').onclick=()=>{ state.m--; if(state.m<0){state.m=11;state.y--;} renderCal(); };
  document.getElementById('next').onclick=()=>{ state.m++; if(state.m>11){state.m=0;state.y++;} renderCal(); };

  /* ===== Notes panel logic ===== */
  const notesPanel = document.getElementById('notesPanel');
  const notesTitle = document.getElementById('notesTitle');
  const notesText  = document.getElementById('notesText');
  const saveBtn    = document.getElementById('saveNotes');
  const delBtn     = document.getElementById('deleteNotes');
  const closeBtn   = document.getElementById('closeNotes');
  const notesStart = document.getElementById('notesStart');
  const notesEnd   = document.getElementById('notesEnd');

  let currentIso = null;
  let editingIndex = -1;

  function findRangeIndexForDate(iso){
    for (let i=0;i<currentRanges.length;i++){
      const r = currentRanges[i];
      if (iso >= r.start && iso <= r.end) return i;
    }
    return -1;
  }

  function openNotes(iso){
    currentIso = iso;
    editingIndex = findRangeIndexForDate(iso);

    if (editingIndex !== -1){
      const r = currentRanges[editingIndex];
      notesStart.value = r.start;
      notesEnd.value   = r.end;
      notesText.value  = r.text || '';
      notesTitle.textContent = `Бележка — ${r.start} → ${r.end}`;
    } else {
      notesStart.value = iso;
      notesEnd.value   = iso;
      notesText.value  = '';
      notesTitle.textContent = `Бележка — ${iso}`;
    }
    notesPanel.classList.add('show');
    notesPanel.setAttribute('aria-hidden','false');
    notesText.focus();
  }

  function closeNotes(){
    notesPanel.classList.remove('show');
    notesPanel.setAttribute('aria-hidden','true');
    currentIso = null;
    editingIndex = -1;
  }

  saveBtn.addEventListener('click', ()=>{
    if (!window.IS_ADMIN) return;
    if (!currentIso) return;

    let a = notesStart.value || currentIso;
    let b = notesEnd.value   || a;
    if (a > b) [a,b] = [b,a];

    const text = (notesText.value || '').trim();
    const arr = [...currentRanges];

    if (!text){
      if (editingIndex !== -1){ arr.splice(editingIndex,1); }
      saveRangesRemote(arr).catch(console.error);
      return;
    }

    const payload = { start:a, end:b, text };
    if (editingIndex !== -1) arr[editingIndex] = payload;
    else arr.push(payload);

    saveRangesRemote(arr).catch(console.error);
    notesTitle.textContent = `Бележка — ${a} → ${b}`;
  });

  delBtn.addEventListener('click', ()=>{
    if (!window.IS_ADMIN) return;
    if (!currentIso) return;
    const arr = [...currentRanges];
    if (editingIndex !== -1){
      arr.splice(editingIndex,1);
      saveRangesRemote(arr).catch(console.error);
    }
    notesText.value = '';
  });
  closeBtn.addEventListener('click', closeNotes);

  /* ===== Auth & Admin (динамичен badge, UID или Email) ===== */
  window.IS_ADMIN = false;

  function setBadge(user, isAdmin){
    const badgeEl = document.getElementById('adminBadge');
    if (!badgeEl){ return; }
    if (!user){
      badgeEl.textContent = 'Статус: гост';
      return;
    }
    badgeEl.textContent = isAdmin ? `Админ: ${user.email}` : `Вход: ${user.email}`;
  }

  async function checkAdmin(user){
    try{
      const snap = await db.collection('meta').doc('admins').get();
      const data = snap.exists ? snap.data() : {};
      const uids   = Array.isArray(data.uids)   ? data.uids   : (Array.isArray(data.list) ? data.list : []);
      const emails = Array.isArray(data.emails) ? data.emails : [];
      const byUid   = user?.uid   && uids.includes(user.uid);
      const byEmail = user?.email && emails.map(s=>String(s).toLowerCase().trim())
                                           .includes(String(user.email).toLowerCase().trim());
      return !!(byUid || byEmail);
    }catch(e){
      console.error('checkAdmin:', e);
      return false;
    }
  }

  auth.onAuthStateChanged(async (user)=>{
    if (!user){
    
      window.IS_ADMIN = false;
      setBadge(null,false);
      return;
    }
    const isAdmin = await checkAdmin(user);
    window.IS_ADMIN = !!isAdmin;
    setBadge(user, isAdmin);
  });

  /* ===== Init ===== */
  renderCal();
  </script>

  <!-- ===== Admin Drawer Logic ===== -->
  <script>
  const adminHotspot = document.getElementById('adminHotspot');
  const adminDrawer  = document.getElementById('adminDrawer');
  const adminClose   = document.getElementById('adminClose');

  function toggleAdminDrawer(force){
    const willShow = typeof force === 'boolean' ? force : !adminDrawer.classList.contains('show');
    adminDrawer.classList.toggle('show', willShow);
    adminDrawer.setAttribute('aria-hidden', String(!willShow));
  }

  adminHotspot.addEventListener('click', (e)=>{ e.stopPropagation(); toggleAdminDrawer(true); });
  adminClose.addEventListener('click',  ()=> toggleAdminDrawer(false));

  document.addEventListener('click', (e)=>{
    const clickInside = adminDrawer.contains(e.target) || adminHotspot.contains(e.target);
    if (!clickInside) toggleAdminDrawer(false);
  });

  const loginBtn  = document.getElementById('adminLogin');
  const logoutBtn = document.getElementById('adminLogout');

  if (loginBtn){
    loginBtn.addEventListener('click', async ()=>{
      toggleAdminDrawer(false);
      const email = prompt('Email за админ вход:');
      if (!email) return;
      const pass = prompt('Парола:');
      if (!pass) return;
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(err){
        alert('Грешен вход: ' + err.message);
      }
    });
  }

  if (logoutBtn){
    logoutBtn.addEventListener('click', async ()=>{
      toggleAdminDrawer(false);
      try{ await auth.signOut(); }catch(e){ console.error(e); }
    });
  }
  </script>
<!-- сложи точно преди </body> -->
<div class="fixed-contacts">
  <a href="tel:+359988988623" class="contact-btn tel" aria-label="Обади се">
    <!-- phone icon -->
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 24 24">
      <path d="M6.62 10.79a15.053 15.053 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 011 1V21a1 1 0 01-1 1C10.29 22 2 13.71 2 3a1 1 0 011-1h4.5a1 1 0 011 1c0 1.25.2 2.46.57 3.59a1 1 0 01-.25 1.01l-2.2 2.19z"/>
    </svg>
  </a>

  <a href="https://wa.me/359988988623" target="_blank" class="contact-btn wa" aria-label="WhatsApp">
    <!-- whatsapp icon -->
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 2a10 10 0 00-8.93 14.58l-1.07 3.92 4.02-1.06A10 10 0 1012 2zm5.2 14.3c-.27.77-1.57 1.48-2.18 1.57-.56.08-1.25.11-2.02-.13-.47-.15-1.07-.35-1.85-.73-3.27-1.62-5.39-5.41-5.55-5.67-.16-.27-1.32-1.76-1.32-3.36 0-1.6.84-2.38 1.14-2.71.3-.34.66-.42.88-.42h.63c.2 0 .47-.07.73.56.27.66.92 2.27 1 2.43.08.16.14.34.03.55-.1.2-.15.34-.3.53-.15.18-.32.4-.46.54-.15.15-.3.31-.13.6.16.27.71 1.17 1.52 1.9 1.04.93 1.9 1.22 2.18 1.36.27.14.43.12.6-.07.16-.2.69-.8.87-1.07.18-.27.36-.23.6-.14.25.09 1.57.74 1.84.88.27.14.45.2.52.31.07.11.07.8-.2 1.56z"/>
    </svg>
  </a>

  <a href="viber://chat?number=%2B359988988623" class="contact-btn viber" aria-label="Viber">
    <!-- viber icon -->
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 24 24">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.031-.967-.273-.099-.472-.148-.67.15-.198.297-.767.966-.94 1.164-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.787-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.173.198-.298.298-.497.099-.198.05-.372-.025-.521-.074-.148-.669-1.611-.916-2.207-.242-.579-.487-.5-.67-.51-.173-.008-.372-.01-.57-.01-.198 0-.52.074-.792.372-.273.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.617h-.005C6.533 22 2 17.468 2 11.993 2 6.518 6.533 2 12.046 2c5.484 0 9.995 4.518 9.995 9.993 0 5.475-4.511 10.007-9.99 10.007z"/>
    </svg>
  </a>
</div>

</body>
</html>
